---
title: 在浏览器地址栏输入URL，按下回车后发生了什么
date: 2018-08-23 09:06:12
categories: 2018年8月
tags: [TCPIP,Web]


---
# 在浏览器地址栏输入URL，按下回车后发生了什么
这道题目没有所谓的完全的正确答案，这个题目可以让你在任意的一个点深入下去， 只要你对这个点是熟悉的。以下是一个大概流程：

<!-- more -->

## 解答1：
### 1.浏览器向DNS服务器查找输入URL对应的IP地址。
### 2.DNS服务器返回网站的IP地址。
### 3.浏览器根据IP地址与目标web服务器在80端口上建立TCP连接
### 4.浏览器获取请求页面的html代码。
### 5.浏览器在显示窗口内渲染HTML。
### 6.窗口关闭时，浏览器终止与服务器的连接。

这其中最有趣的是第1步和第2步(域名解析)。我们输入的网址(域名)是IP地址的一个别名， 在一个DNS内，一个域名对应一个IP地址。域名系统(DNS) 的工作就是将域名与它的IP地址对应起来。DNS是分布式的，同时也是具有层级关系的。

## 解答2：

当我们用浏览器访问一个网页时，浏览器先尝试从Host文件中获取 http://www.baidu.com/对应的IP地址，如何不能取到就是用DNS协议来获取IP。在DNS协议中PC会向你的本地DNS服务器求助（一般是路由器），希望从本地DNS服务器那里得到百度的IP，如果得不到本地DNS服务器会向更高层次的DNS服务器求助.......,最终总能得到百度的IP。

得到百度的IP，下一步使用TCP协议，建立TCP连接。在TCP协议中建立TCP需要与百度服务器握手三次，你先告诉服务器你要给服务器发东西（SYN），服务器应答你并告诉你它也要给你发东西（SYN，ACK），然后你向应答服务器（SYN，ACK）做出应答，总共来回了三次，成为3次握手。不过，建立TCP连接有个前提，你必须能够成功地把消息发到服务器上。

为了将消息从你的PC上传到服务器上，需要用到IP协议、ARP协议和OSPF协议。我们都知道，你的PC和百度服务器之间一般会有许多路由器之类的东西，IP协议指定了出发地和目的地；你的数据会经过一个又一个路由器，OSPF决定了会经过哪些路由器（用一种路由算法，找出最佳路径）从一个路由器怎么传给下一个路由器，这是ARP协议的工作，ARP负责求下一个节点的地址。IP协议使用的是IP地址，整个发送过程中只涉及出发地和目的地2个IP地址，而ARP协议使用的是MAC地址，整个发送过程中涉及到每一个节点的MAC地址。

现在，我们能和服务器通信，还建立TCP连接，下一步就是用HTTP协议请求网页内容了。你发个http请求报文给服务器，如果服务器禁止你访问就给你回个“forbidden”，如果他暂时挂掉了就给你回个“内部服务错误”，如果它正常才给你回个“OK”，并将你要的数据传给你；如果你有其他需要的东西再去给他要。你收到了服务器的回复，是一坨html的文本，浏览器必须能够理解文本的内容，并快速的渲染到屏幕上。渲染出来后，就可以看到网页了。

## 解答3

### 基本流程：
①查询ip地址

②建立tcp连接，接入服务器

③浏览器发起http请求

④服务器后台操作并做出http响应

⑤网页的解析与渲染

### 具体步骤

查询ip地址
①浏览器解析出url中的域名。

②查询浏览器的DNS缓存。

③浏览器中没有DNS缓存，则查找本地客户端hosts文件有无对应的ip地址。

④hosts中无，则查找本地DNS服务器（运营商提供的DNS服务器）有无对应的DNS缓存。

⑤若本地DNS没有DNS缓存，则向根服务器查询，进行递归查找。

⑥递归查找从顶级域名开始（如.com）,一步步缩小范围，最终客户端取得ip地址。

 

tcp连接与http连接
①http协议建立在tcp协议之上，http请求前，需先进行tcp连接，形成客户端到服务器的稳定的通道。俗称TCP的三次握手。

②tcp连接完成后，http请求开始，请求有多种方式，常见的有get，post等。

③http请求包含请求头，也可能包含请求体两部分，请求头中包含我们希望对请求文件的操作的信息，请求体中包含传递给后台的参数。

④服务器收到http请求后，后台开始工作，如负载平衡，跨域等，这里就是后端的工作了。

⑤文件处理完毕，生成响应数据包，响应也包含两部分，响应头和相应体，响应体就是我们所请求的文件。

⑥经过网络传输，文件被下载到本地客户端，客户端开始加载。

 

html渲染
①客户端浏览器加载了html文件后，由上到下解析html为DOM树（DOM Tree）。

②遇到css文件，css中的url发起http请求。

③这是第二次http请求，由于http1.1协议增加了Connection: keep-alive声明，故tcp连接不会关闭，可以复用。

④http连接是无状态连接，客户端与服务器端需要重新发起请求--响应。

在请求css的过程中，解析器继续解析html，然后到了script标签。

⑤由于script可能会改变DOM结构，故解析器停止生成DOM树，解析器被js阻塞，等待js文件发起http请求，然后加载。这是第三次http请求。js执行完成后解析器继续解析。

⑥由于css文件可能会影响js文件的执行结果，因此需等css文件加载完成后再执行。

⑦浏览器收到css文件后，开始解析css文件为CSSOM树（CSS Rule Tree）。

⑧CSSOM树生成后，DOM Tree与CSS Rule Tree结合生成渲染树（Render Tree）。

⑨Render Tree会被css文件阻塞，渲染树生成后，先布局，绘制渲染树中节点的属性(位置，宽度，大小等)，然后渲染，页面就会呈现信息。

⑩继续边解析边渲染，遇到了另一个js文件，js文件执行后改变了DOM树，渲染树从被改变的dom开始再次渲染。

⑪继续向下渲染，碰到一个img标签，浏览器发起http请求，不会等待img加载完成，继续向下渲染，之后再重新渲染此部分。

⑫DOM树遇到html结束标签，停止解析，进而渲染结束。

### 扩展思考
有那些网站优化的方法？
①减少DNS查询:将服务器域名的ip信息加入本地host文件。

②减少http请求数量，对于图片使用雪碧图,对于html文件和css文件，js文件分别进行合并操作。

③减少下载时间：压缩图片，使用压缩应用压缩文档中的空格，删除文件多余的语句和注释，创造自己的js精简库和精简框架,使用本地浏览器缓存。

④提前渲染开始时间：将css链接放在html头部。

⑤减轻解析器的阻塞：将js链接放在body尾部